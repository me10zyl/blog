<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>MySQL 数据库备份 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="热备与冷备数据库的备份与恢复是一项最基本但是却不简单的工作，根据不同类型来划分备份的方法，划分出最基础的两种备份，热备与冷备。冷备是指在数据库停止的情况下，一般只需要复制相关数据库文件，而热备即在数据库运行的时候直接备份，对正在运行的数据库没有任何影响。  以下通过两种备份来保证数据的安全，复制备份与快照备份。复制备份用于数据库实时备份，当开发人员对主数据库进行误操作时，其结果也会应用到从数据库，">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 数据库备份">
<meta property="og:url" content="http://yoursite.com/2017/04/13/2017-01-16-mysql-backup/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="热备与冷备数据库的备份与恢复是一项最基本但是却不简单的工作，根据不同类型来划分备份的方法，划分出最基础的两种备份，热备与冷备。冷备是指在数据库停止的情况下，一般只需要复制相关数据库文件，而热备即在数据库运行的时候直接备份，对正在运行的数据库没有任何影响。  以下通过两种备份来保证数据的安全，复制备份与快照备份。复制备份用于数据库实时备份，当开发人员对主数据库进行误操作时，其结果也会应用到从数据库，">
<meta property="og:updated_time" content="2017-04-10T01:58:14.475Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL 数据库备份">
<meta name="twitter:description" content="热备与冷备数据库的备份与恢复是一项最基本但是却不简单的工作，根据不同类型来划分备份的方法，划分出最基础的两种备份，热备与冷备。冷备是指在数据库停止的情况下，一般只需要复制相关数据库文件，而热备即在数据库运行的时候直接备份，对正在运行的数据库没有任何影响。  以下通过两种备份来保证数据的安全，复制备份与快照备份。复制备份用于数据库实时备份，当开发人员对主数据库进行误操作时，其结果也会应用到从数据库，">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Søk"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2017-01-16-mysql-backup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/13/2017-01-16-mysql-backup/" class="article-date">
  <time datetime="2017-04-13T09:55:23.964Z" itemprop="datePublished">2017-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      MySQL 数据库备份
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="热备与冷备"><a href="#热备与冷备" class="headerlink" title="热备与冷备"></a>热备与冷备</h2><p>数据库的备份与恢复是一项最基本但是却不简单的工作，根据不同类型来划分备份的方法，划分出最基础的两种备份，热备与冷备。冷备是指在数据库停止的情况下，一般只需要复制相关数据库文件，而热备即在数据库运行的时候直接备份，对正在运行的数据库没有任何影响。 </p>
<p>以下通过两种备份来保证数据的安全，复制备份与快照备份。复制备份用于数据库实时备份，当开发人员对主数据库进行误操作时，其结果也会应用到从数据库，所以需要对从数据库进行快照(snapshot)来防止从数据库数据丢失。</p>
<h2 id="1-复制备份"><a href="#1-复制备份" class="headerlink" title="1. 复制备份"></a>1. 复制备份</h2><p>同大多数关系型数据库一样，日志文件是MySQL数据库的重要组成部分。MySQL有几种不同的日志文件，通常包括错误日志文件，二进制日志，通用日志，慢查询日志，等等。这些日志可以帮助我们定位mysqld内部发生的事件，数据库性能故障，记录数据的变更历史，用户恢复数据库等等。  </p>
<p>其中二进制日志可用于MySQL数据库的备份，通过一个完全备份进行二进制日志的重做来完成数据库的point-in-time的恢复工作，MySQL数据库复制(replication)的原理就是异步实时地将二进制日志重做传送并应用到从数据库。</p>
<p>MySQL 复制是MySQL数据库提供的一种高可用高性能的解决方案，复制的原理并不难，其实就是一个完全备份加上二进制日志备份的还原。</p>
<h2 id="2-快照备份"><a href="#2-快照备份" class="headerlink" title="2. 快照备份"></a>2. 快照备份</h2><p><code>Logical Volume Manager (LVM)</code>提供了对任意一个<code>Logical Volume(LV)</code>做“快照”(snapshot)的功能，以此来获得一个分区的状态一致性备份。<br>在某一个状态下做备份的时候，可能有应用正在访问某一个文件或者数据库，这就是使得备份的时候文件处于一个状态，而备份完后，文件却处于另外一个状态，从而造成备份的非一致性，这种状态恢复数据库数据几乎不会成功。</p>
<p>状态的解决办法是将其分区挂载为只读，然后通过数据库的表级别锁定(table-level write locks)甚至停止数据库来备份数据。所有这些方法无意严重影响了服务的可用性。使用LVM snapshot既可以获得一致性备份，又不会影响服务器的可用性。</p>
<h2 id="3-开始备份"><a href="#3-开始备份" class="headerlink" title="3. 开始备份"></a>3. 开始备份</h2><h4 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h4><p>有两台服务器<code>192.168.2.5</code>与<code>192.168.2.230</code>，在同一局域网，为了快速部署并且不影响操作系统，将使用<code>docker</code>作为运行<code>mysql</code>的容器。<br>从<code>docker hub</code>拉取或者自己制作一个镜像，这里已经在<code>192.168.2.5</code>制作好了一个镜像，并已经push到了<code>192.168.2.230</code>。</p>
<p>开始在<code>192.168.2.5</code> <strong>运行MySQL</strong>:</p>
<pre><code>docker run -d -h mysql-server --restart=always --name=mysql_server -p 3306:3306 -v /mnt1/data/mysql:/mnt/data/mysql-online 192.168.2.230:5000/sunyuki/mysqllinux:latest
</code></pre><p>这样会运行一个<code>docker</code>容器，并且将<code>docker</code>中的<code>mysql</code>数据库文件<code>mnt/data/mysql-online</code>挂载到了本地磁盘<code>/mnt1/data/mysql</code>。</p>
<p>同样的，在<code>192.168.2.230</code>执行相同的命令，这样在两台机器的运行的<code>mysql</code>是一样的，并且两个容器的名称是<code>mysql_server</code>。</p>
<h4 id="2-启用数据库二进制日志"><a href="#2-启用数据库二进制日志" class="headerlink" title="2.启用数据库二进制日志"></a>2.启用数据库二进制日志</h4><p>因为复制的原理是重做二进制日志，所以需要为两台机器都启用二进制日志。</p>
<p>两台机器都运行起<code>docker</code>容器后，连接到<code>192.168.2.5</code>进入<code>mysql_server</code>容器更改配置文件:</p>
<pre><code>docker exec -it mysql_server /bin/bash
</code></pre><p>在数据库配置文件中设置(通常为<code>/etc/my.cnf</code>):</p>
<pre><code>[mysqld]
log-bin = mysql-bin
sync_binlog = 1
innodb_support_xa = 1
</code></pre><p>连接到<code>192.168.2.230</code>做同样的操作。</p>
<p>这样两台机器都启用了二进制日志。</p>
<h4 id="2-更改数据库-server-id"><a href="#2-更改数据库-server-id" class="headerlink" title="2.更改数据库 server-id"></a>2.更改数据库 server-id</h4><p>打算将<code>192.168.230</code>作为<strong>从服务器</strong>，<code>192.168.2.5</code>作为<strong>主服务器</strong>，需要将两台机器的数据库<code>server-id</code>更改的不一样。  </p>
<p>在<code>192.168.2.230</code>:<br>进入docker容器:</p>
<pre><code>docker exec -it mysql_server /bin/bash
</code></pre><p>更改数据库配置文件:</p>
<pre><code>[mysqld]
server-id = 2
</code></pre><p>并且重命名<code>192.168.2.230</code>中的 <code>auto.cnf</code>:</p>
<pre><code>mv auto.cnf auto.cnf.bak
</code></pre><p>重命名这个文件的原因是这个文件定义了两台服务器的<code>uuid</code>，因为两台服务器的<code>docker</code>镜像是一样的，所以要让<code>mysql</code>重新生成<code>uuid</code>。</p>
<p><code>auto.cnf</code>中的内容一览:</p>
<pre><code>[auto]
server-uuid=9f31bddf-d965-11e6-9c77-0242ac110003
</code></pre><p>重启<code>mysql</code></p>
<pre><code>service mysql restart
</code></pre><p>在<code>192.168.2.5</code>:<br>进入docker容器:</p>
<pre><code>docker exec -it mysql_server /bin/bash
</code></pre><p>更改数据库配置文件:</p>
<pre><code>[mysqld]
server-id = 1
</code></pre><p>重启<code>mysql</code></p>
<pre><code>service mysql restart
</code></pre><h4 id="3-配置主从数据库"><a href="#3-配置主从数据库" class="headerlink" title="3.配置主从数据库"></a>3.配置主从数据库</h4><p>在<code>192.168.2.5</code>:<br>进入<code>192.168.2.5</code>的<code>docker</code>容器:<br>创建新用户用于复制功能:</p>
<pre><code>mysql&gt; CREATE USER &apos;repl&apos;@&apos;192.168.2.230&apos; IDENTIFIED BY &apos;repl&apos;;
mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &apos;repl&apos;@&apos;192.168.2.230&apos;;
</code></pre><p>如果想看一下结果，可以查看<code>mysql</code>用户</p>
<pre><code>mysql&gt; select user,host from mysql.user;
</code></pre><p>首先查询主数据库日志文件位置:  </p>
<pre><code>mysql&gt; show master status

| file             | position |
| mysql-bin.000017 | 120      |
</code></pre><p>获取到两个重要的信息，二进制日志文件名与执行位置  </p>
<p>在<code>192.168.2.230</code>:<br>进入<code>192.168.2.230</code>的<code>docker</code>容器:<br>配置从服务器:</p>
<pre><code>mysql&gt; CHANGE MASTER TO
MASTER_HOST =&apos;192.168.2.5&apos;,
MASTER_USER =&apos;repl&apos;,
MASTER_PASSWORD =&apos;repl&apos;,
MASTER_LOG_FILE =&apos;mysql-bin.000017&apos;,
MASTER_LOG_POS =120;
</code></pre><p>其中<code>MASTER_LOG_FILE</code>与<code>MASTER_LOG_POS</code>要与主数据库中的<code>show master status</code>的结果一致。</p>
<p>开启从数据库:</p>
<pre><code>mysql&gt; start slave;
</code></pre><p>查看是否配置成功:</p>
<pre><code>mysql&gt; show slave status;

| Slave_IO_Running | Slave_SQL_Running | Last_IO_Error | Last_SQL_Error|
| yes              | yes               |               |               |
</code></pre><p>如果<code>Slave_SQL_Running</code>与<code>Slave_IO_Running</code>其中一个不是<code>yes</code>，就没有配置成功，具体错误可以在<code>Last_IO_Error</code>和<code>Last_SQL_Error</code>中查看。</p>
<p>依据这个原理，可以写一个脚本用户实时的去检查主从数据库是不是出错，如果出错了就发邮件给管理者，这里使用的是<code>python</code>写的脚本。</p>
<p>安装<code>mysql-connector for python</code>:</p>
<pre><code>wget https://dev.mysql.com/get/Downloads/Connector-Python/mysql-connector-python-2.1.5-1.el6.x86_64.rpm
rpm -i mysql-connector-python-2.1.5-1.el6.x86_64.rpm
</code></pre><p>安好connector后开始写<code>python</code>脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="keyword">import</span> mysql.connector</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> smtplib</div><div class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</div><div class="line"></div><div class="line"><span class="comment"># mysql</span></div><div class="line">HOST = <span class="string">'127.0.0.1'</span></div><div class="line">USER = <span class="string">'xxx'</span></div><div class="line">PASSWORD = <span class="string">'xxxx'</span></div><div class="line">LOG_FILE = <span class="string">'/var/log/mysqlchk.log'</span></div><div class="line">TIME_GAP = <span class="number">120</span>  <span class="comment"># interval time gap (unit seconds)</span></div><div class="line"></div><div class="line"><span class="comment"># smtp</span></div><div class="line">mailto_list = [<span class="string">"me@qq.com"</span>]</div><div class="line">mail_host = <span class="string">"smtp.domain.com"</span></div><div class="line">mail_user = <span class="string">"xxx"</span></div><div class="line">mail_pass = <span class="string">"xxx"</span></div><div class="line">mail_postfix = <span class="string">"domain.com"</span></div><div class="line">mail_nick_name = <span class="string">'MySQL CHK'</span></div><div class="line">mail_subject = <span class="string">'[ERROR] MySQL Replication Error'</span></div><div class="line"></div><div class="line">logger = logging.getLogger(__name__)</div><div class="line">logger.setLevel(logging.INFO)</div><div class="line"><span class="comment"># create a file handler</span></div><div class="line">handler = logging.FileHandler(LOG_FILE)</div><div class="line">handler.setLevel(logging.INFO)</div><div class="line"><span class="comment"># create a logging format</span></div><div class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</div><div class="line">handler.setFormatter(formatter)</div><div class="line"><span class="comment"># add the handlers to the logger</span></div><div class="line">logger.addHandler(handler)</div><div class="line"></div><div class="line">logger.info(<span class="string">'program start'</span>)</div><div class="line">cnx = mysql.connector.connect(user=USER, password=PASSWORD, host=HOST)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_mail</span><span class="params">(to_list, sub, content)</span>:</span></div><div class="line">    me = mail_nick_name + <span class="string">"&lt;"</span> + mail_user + <span class="string">"@"</span> + mail_postfix + <span class="string">"&gt;"</span></div><div class="line">    msg = MIMEText(content, _subtype=<span class="string">'plain'</span>, _charset=<span class="string">'gb2312'</span>)</div><div class="line">    msg[<span class="string">'Subject'</span>] = sub</div><div class="line">    msg[<span class="string">'From'</span>] = me</div><div class="line">    msg[<span class="string">'To'</span>] = <span class="string">";"</span>.join(to_list)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        server = smtplib.SMTP()</div><div class="line">        server.connect(mail_host)</div><div class="line">        server.login(mail_user, mail_pass)</div><div class="line">        server.sendmail(me, to_list, msg.as_string())</div><div class="line">        server.close()</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">except</span> Exception, e:</div><div class="line">        <span class="keyword">print</span> str(e)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">()</span>:</span></div><div class="line">        logger.info(<span class="string">'start check slave status..'</span>)</div><div class="line">        cur = cnx.cursor()</div><div class="line">        query = (<span class="string">"show slave status"</span>)</div><div class="line">        cur.execute(query)</div><div class="line">        res = cur.fetchone()</div><div class="line">        (slave_io_running, slave_sql_running, last_io_error) = (res[<span class="number">10</span>], res[<span class="number">11</span>], res[<span class="number">35</span>])</div><div class="line">        <span class="keyword">if</span> slave_io_running != <span class="string">'yes'</span> <span class="keyword">and</span> slave_sql_running != <span class="string">'yes'</span>:</div><div class="line">            error = <span class="string">'[ERROR]Slave Error:&#123;0&#125;'</span>.format(last_io_error);</div><div class="line">            logger.error(error)</div><div class="line">            send_mail(mailto_list, mail_subject, error)</div><div class="line">        cur.close()</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        check()</div><div class="line">        time.sleep(TIME_GAP)</div><div class="line"><span class="keyword">except</span> Exception, e:</div><div class="line">    logger.error(str(e))</div><div class="line">    send_mail(mailto_list, mail_subject, str(e))</div><div class="line"><span class="keyword">finally</span>:</div><div class="line">    cnx.close</div><div class="line">    logger.info(<span class="string">'program terminate'</span>)</div></pre></td></tr></table></figure>
<p>这个脚本的用处就是每两分钟去检测主从服务器连接是否正常，如果不正常将会发送错误消息给管理员。<br>到这里主从数据库配置就完成了，可以通过连接<code>192.168.2.5</code>，执行数据库创建操作，然后再到<code>192.168.2.230</code>看新的数据库是否创建来试验<code>mysql</code>的复制(replication)功能。</p>
<h4 id="4-自动创建快照"><a href="#4-自动创建快照" class="headerlink" title="4.自动创建快照"></a>4.自动创建快照</h4><p>这一步开始在<strong>从数据库</strong>所在服务器<code>192.168.2.230</code>的数据库文件进行快照的操作，其实这一步之前，将<code>mysql</code>的数据库文件路径<code>/mnt1/data/mysql</code>挂载到了一个专用的LVM逻辑卷。<br>在<code>192.168.2.230</code>执行（不进入<code>docker</code>):<br>查看分区:</p>
<pre><code>root@syk230# fdisk -l
    Device     Boot   Start        End    Sectors  Size Id Type
/dev/sda1  *       2048     999423     997376  487M 83 Linux
/dev/sda2       1001470 3907028991 3906027522  1.8T  5 Extended
/dev/sda5       1001472 3907028991 3906027520  1.8T 8e Linux LVM
</code></pre><p>查看卷组:</p>
<pre><code>root@syk230# vgdisplay
      --- Volume group ---
  VG Name               syk230-vg
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  52
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                4
  Open LV               3
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               1.82 TiB
  PE Size               4.00 MiB
  Total PE              476809
  Alloc PE / Size       11076 / 43.27 GiB
  Free  PE / Size       465733 / 1.78 TiB
  VG UUID               brRcUd-vF1G-rWjH-EJW5-jiWG-fsrN-j2RtlN
</code></pre><p>在<code>syk230-vg</code>卷组上创建一个名为<code>mysql</code>的逻辑卷，大小为3G:</p>
<pre><code>lvcreate -L 3G -n mysql syk230-vg
</code></pre><p>查看逻辑卷:</p>
<pre><code>root@syk230# lvdisplay
  --- Logical volume ---
  LV Path                /dev/syk230-vg/mysql
  LV Name                mysql
  VG Name                syk230-vg
  LV UUID                09gVIy-r0vY-rGrX-G6sf-EDm4-483o-ZDaO66
  LV Write Access        read/write
  LV Creation host, time syk230, 2017-01-12 12:16:22 +0800
  LV snapshot status     source of
                         mysqlsnap [active]
  LV Status              available
  # open                 1
  LV Size                3.00 GiB
  Current LE             768
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           252:2
</code></pre><p>格式化分区(ext4):</p>
<pre><code>mkfs.ext4 /dev/syk230-vg/mysql
</code></pre><p>挂载分区:</p>
<pre><code>vim /etc/fstab
</code></pre><p>添加内容:</p>
<pre><code>/dev/mapper/syk230--vg-mysql /mnt1/data/mysql ext4 defaults 0 2
</code></pre><p>至此，为存储mysql数据逻辑卷创建好了。<br><strong>编写自动创建备份的脚本</strong>:</p>
<pre><code>#!/bin/bash
tmppath=/mnt1/data/mysqlbak1
bakpath=/mnt1/data/mysqlbak
filename=`date +%Y%m%d.tar.gz`
binpos=/tmp/binpos.log

mysql -h 172.17.0.2 -u zyl --password=zyl -e &quot;flush tables with read lock&quot;
mysql -h 172.17.0.2 -u zyl --password=zyl -e &quot;show master status\G&quot; | grep &apos;File\|Position&apos; | xargs &gt; $binpos
mysql -h 172.17.0.2 -u zyl --password=zyl -e &quot;show slave status\G&quot; | grep &apos;Relay_Log_File\|Relay_Log_Pos&apos; | xargs &gt;&gt; $binpos
lvcreate -s -n mysqlsnap1 -L 5G /dev/syk230-vg/mysql
mysql -h 172.17.0.2 -u zyl --password=zyl -e &quot;unlock tables&quot;
if [ ! -d &quot;$tmppath&quot; ]; then
        mkdir $tmppath
fi
if [ ! -d &quot;$bakpath&quot; ]; then
        mkdir $bakpath
fi
mount /dev/syk230-vg/mysqlsnap1 $tmppath
mv $binpos $tmppath
tar -czf &quot;$bakpath/$filename&quot; -C $tmppath .
umount $tmppath
rmdir $tmppath
lvremove -f /dev/syk230-vg/mysqlsnap1
</code></pre><p>其中<code>172.17.0.2</code>是<code>docker</code>中<code>mysql_server</code>容器本机内网ip。可以通过</p>
<pre><code>docker network inspect bridge
</code></pre><p>查询。<br>将执行脚本计划添加到<code>crontab</code>中:</p>
<pre><code>crontab -e
</code></pre><p>添加内容</p>
<pre><code>0 0 * * * /bin/bash /mnt1/data/mysqlbak.sh
</code></pre><p>这样每天凌晨备份一次数据库，并且不需要停止数据库。</p>
<p><strong>删除30天之前的备份</strong>  </p>
<pre><code>find /mnt1/data/mysqlbak -mtime +30 -delete &gt; /mnt1/data/mysqldel.sh
chmod 755 /mnt1/data/mysqldel.sh
</code></pre><p>crontab 添加内容:</p>
<pre><code>0 0 * * * /bin/bash /mnt1/data/mysqldel.sh
</code></pre><h2 id="4-小结"><a href="#4-小结" class="headerlink" title="4.小结"></a>4.小结</h2><p>总的说来，配置MySQL的复制功能比配置LVM简单太多,主要是因为是否能正确的使用LVM快照功能跟硬盘配置选项有直接的关系，主要有以下几点需要注意到： </p>
<ul>
<li>安装系统的时候要选LVM管理的磁盘</li>
<li>安装系统分区的时候<strong>一定不要将系统分区占满整个磁盘</strong>，否则LVM无法分配新的空间来创建逻辑卷，且系统分区不可删除和缩小(否则需要用<code>cd-live</code>或者<code>usb-live</code>)</li>
<li>添加新硬盘的时候用<code>pvcreate</code>,<code>vgcreate</code>分别来创建物理卷和卷组</li>
<li>如果安装系统时没有选择LVM，用<code>fdisk</code>创建新的分区并且更改磁盘类型为<code>8e</code>(LVM类型代码)</li>
</ul>
<p>结合MySQL的复制功能和LVM的快照功能，既能保证数据的实时同步，又能防止程序或数据库管理员的误操作。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/13/2017-01-16-mysql-backup/" data-id="cj1g8bsa20002i8tt42ns909h" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/04/13/2016-10-10-CSS/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CSS 盒子模型
        
      </div>
    </a>
  
  
    <a href="/2017/04/13/2017-02-14-mysql-restore/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">MySQL 数据库恢复</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Arkiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Siste innlegg</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/13/2017-04-14-java-tutorial/">Java程序设计</a>
          </li>
        
          <li>
            <a href="/2017/04/13/2017-02-14-mysql-restore/">MySQL 数据库恢复</a>
          </li>
        
          <li>
            <a href="/2017/04/13/2017-01-16-mysql-backup/">MySQL 数据库备份</a>
          </li>
        
          <li>
            <a href="/2017/04/13/2016-10-10-CSS/">CSS 盒子模型</a>
          </li>
        
          <li>
            <a href="/2017/04/13/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>